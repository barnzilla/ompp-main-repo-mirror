<?xml version="1.0" encoding="utf-8"?>
<Project InitialTargets="Diagnostics" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  
  <!-- 
  Validate
  -->


  <Target Name="Validate">
    <Error  Text="MODEL_NAME cannot be empty"
            Condition=" ( '$(MODEL_NAME)' == '' )" />
  </Target>

  
  <!-- 
  Clean
  -->

  
  <Target Name="ModgenClean">
    <Message Text="Delete modgen compiler output" />
    <RemoveDir Directories="$(MODGEN_OUT_DIR)" />
  </Target>
  
  <Target Name="ScexPublishClean">
    <Message Text="Delete ScexPublish output" />
    <Delete Files="$(SCENARIO_SCEX)" />
  </Target>

  <PropertyGroup>
    <CleanDependsOn>ModgenClean;ScexPublishClean;$(CleanDependsOn)</CleanDependsOn>
  </PropertyGroup>
 
 
  <!-- 
  Build
  -->
 
 
  <Target Name="ModgenCompile"
          Inputs="@(MODGEN_INPUTS)"
          Outputs="@(MODGEN_OUTPUTS)"
          >
    <MakeDir Directories="$(MODGEN_OUT_DIR)" />
    <PropertyGroup>
      <START_TIME>$([System.DateTime]::Now)</START_TIME>
    </PropertyGroup>
    <Exec WorkingDirectory="$(MODGEN_IN_DIR)"
          Command="$(COMPLETE_MODGEN_EXE) -D $(MODGEN_OUT_DIR) -EN" 
    />
    <Message Text="Modgen elapsed time: $([System.DateTime]::Now.Subtract($(START_TIME)))" />
    <Exec Command="$(COMPLETE_PATCH_MODGEN_OUTPUTS_EXE) $(MODGEN_OUT_DIR)" />
    <Touch Files="@(MODGEN_OUTPUTS)" />
    <WriteLinesToFile 
        Condition="!Exists('$(PCH_CXX)')"
        File="$(PCH_CXX)"
        Lines="#include &quot;model.h&quot;"
        Overwrite="true"
        Encoding="Unicode"
    />
  </Target>

  <PropertyGroup>
    <BuildDependsOn>ModgenCompile;$(BuildDependsOn)</BuildDependsOn>
  </PropertyGroup>
 
 
  <!-- 
  ScexPublish
  -->
  <ItemGroup>
    <FRAMEWORK_ODAT Include="$(MODEL_PARAM_DIR)/$(SCENARIO_NAME)/*Framework*.odat" />
  </ItemGroup>
 
  <PropertyGroup>
    <FRAMEWORK_OMPP>$(MODEL_CODE_DIR)/ompp_framework.ompp</FRAMEWORK_OMPP>
    <SCENARIO_SCEX>$(MODEL_BIN_DIR)/$(SCENARIO_NAME).scex</SCENARIO_SCEX>
  </PropertyGroup>
 
  <Target Name="ScexPublish"
          Inputs="@(FRAMEWORK_ODAT);$(FRAMEWORK_OMPP);@(SCENARIO_DATS)"
          Outputs="$(SCENARIO_SCEX)"
          AfterTargets="Build"
          >
    <Error
        Condition="'1' != '@(FRAMEWORK_ODAT->Count())'"
        Text="Cannot find framework .odat file"
    />
    <MakeDir Directories="$(MODGEN_OUT_DIR)" />
    <Message
          Text="$(COMPLETE_CREATE_SCEX_EXE) $(SCENARIO_SCEX) @(FRAMEWORK_ODAT) $(FRAMEWORK_OMPP) @(SCENARIO_DATS, ' ')"
    />
    <Exec WorkingDirectory="$(MODGEN_IN_DIR)"
          Command="$(COMPLETE_CREATE_SCEX_EXE) $(SCENARIO_SCEX) @(FRAMEWORK_ODAT) $(FRAMEWORK_OMPP) @(SCENARIO_DATS, ' ')" 
    />
  </Target>

 
  <!-- 
  Diagnostics
  -->
 
 
  <Target Name="Diagnostics"
          Condition="'1'=='1'">
    <Message Text="OM_ROOT=$(OM_ROOT)" />
    <Message Text="MODGEN_ROOT=$(MODGEN_ROOT)" />
    <Message Text="MODGEN_INPUTS=@(MODGEN_INPUTS)" />
    <Message Text="MODGEN_OUTPUTS=@(MODGEN_OUTPUTS)" />
  </Target>

</Project>